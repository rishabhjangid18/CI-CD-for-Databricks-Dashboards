name: Databricks Dashboards CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:   # allow manual trigger from Actions tab

jobs:
  validate_dev:
    name: Validate Databricks Bundle (Dev)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          databricks --version

      - name: Validate Bundle (Dev)
        run: |
          databricks bundle validate --target dev --file databricks.yaml
        env:
          DATABRICKS_HOST: ${{ secrets.DEV_DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DEV_DATABRICKS_TOKEN }}
          SQL_WAREHOUSE_ID: ${{ secrets.SQL_WAREHOUSE_ID_DEV }}

  deploy_dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: validate_dev
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          databricks --version

      - name: Deploy Bundle (Dev)
        run: |
          databricks bundle deploy --target dev --file databricks.yaml
        env:
          DATABRICKS_HOST: ${{ secrets.DEV_DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DEV_DATABRICKS_TOKEN }}
          SQL_WAREHOUSE_ID: ${{ secrets.SQL_WAREHOUSE_ID_DEV }}

  deploy_prod:
    name: Deploy to Prod
    runs-on: ubuntu-latest
    needs: deploy_dev
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Databricks CLI
        run: |
          curl -fsSL https://raw.githubusercontent.com/databricks/setup-cli/main/install.sh | sh
          databricks --version

      - name: Deploy Bundle (Prod)
        run: |
          databricks bundle deploy --target prod --file databricks.yaml
        env:
          DATABRICKS_HOST: ${{ secrets.PROD_DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.PROD_DATABRICKS_TOKEN }}
          SQL_WAREHOUSE_ID: ${{ secrets.SQL_WAREHOUSE_ID_PROD }}
